---
title: "Crunching Function for XlsForm"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{crunching-function-for-xlsform}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(kobocruncher)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/flat_dev.Rmd: do not edit by hand -->

# Data examples to demo the package

<!-- 
 Store your dataset in a directory named "inst/" at the root of your project.
 Use it for your tests in this Rmd thanks to `pkgload::load_all()` to make it available
and `system.file()` to read it in your examples.
-->


# Preparing objects 

## Data loading

```{r examples-kobo_data}
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )
# MainFrame
datalist[1]
# Second Frame - based on presence of repeat within the form, aka nested or
# hierarchical data structure, etc... 
datalist[2]  
```

## Extend the xlsform to add instructions for the analysis plan

Now we can extend the xlsform that was used to document key next steps in the data preparation.


```{r examples-kobo_prepare_form}
# kobo_prepare_form(xlsformpath = system.file("form.xlsx", package = "kobocruncher"),
#                   xlsformpathout = "form_with_plan.xlsx")
```

## Prepare data dictionnary

```{r examples-kobo_dico}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
# Survey
questions <- as.data.frame(dico[1])
knitr::kable(head(questions, 10))
# Choices
responses <- as.data.frame(dico[2])
knitr::kable(head(responses, 10))
# Settings
metadata <- as.data.frame(dico[3])
knitr::kable(head(metadata, 10))
# Report ToC
toc <- as.data.frame(dico[4])
knitr::kable(head(toc, 10))
```

# Data Processing

## Cleaning

## Anonymisation

## Indicator Calculation

# Labeling functions

## Get the correct frame for a specific variable

```{r examples-kobo_frame}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

data <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = "members.sex"   )
knitr::kable(head(data,5))
 
```

## Get the label for a specific variable

```{r examples-label_varname}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )

label_varname(dico = dico, 
              x ="profile.country")

```

## Get interpretation hint for a specific variable

```{r examples-label_varhint}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )

label_varhint(dico = dico, 
              x ="profile.country")
```

## Get all the choices labels options for a specific variable

```{r examples-label_choiceset}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

data <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = "profile.country"   )

label_choiceset(dico = dico, 
                x="profile.country")(data$profile.country)

## Test when there's no dictionnary
data$profile.occupation
label_choiceset(dico = dico, 
                x="profile.occupation")(data$profile.occupation)
```

# Plotting Functions

## Plotting Select one variable

```{r examples-plot_select_one}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_select_one(datalist = datalist,
              dico = dico, 
              var = "profile.country",
              showcode = TRUE)

plot_select_one(datalist = datalist,
              dico = dico, 
              var = "profile.countryerror",
              showcode = TRUE)
```

## Plotting Select one variable with cross tabulation

```{r examples-plot_select_one_cross}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_select_one_cross(datalist = datalist,
              dico = dico, 
              var = "profile.country",
              by_var = "profile.occupation",
              showcode = TRUE
              )
```

## Plotting Select multiple variable

```{r examples-plot_select_multiple}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )


plot_select_multiple(datalist = datalist,
              dico = dico, 
              var = "profile.reason",
              showcode = TRUE
            )

plot_select_multiple(datalist = datalist,
              dico = dico, 
              var = "profile.reason1",
              showcode = TRUE
            )

```

## Plotting Select multiple variable with cross-tabulation

```{r examples-plot_select_multiple_cross}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_select_multiple_cross(datalist = datalist,
              dico = dico, 
              var = "profile.reason",
              by_var = "location",
              showcode = TRUE)
```

## Plotting Numeric variable

```{r examples-plot_integer}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_integer(datalist = datalist,
              dico = dico, 
              var = "members.age",
              showcode = TRUE)
```

## Plotting Numeric variable with cross-tabulation

```{r examples-plot_integer_cross}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_integer_cross(datalist = datalist,
              dico = dico, 
              var = "members.age",
              by_var = "members.sex",
              showcode = TRUE)
```

## Plotting Open Text variable

```{r examples-plot_text}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_text(datalist = datalist,
              dico = dico, 
              var = "profile.occupation",
              showcode = TRUE)
```

## Plotting Correlation

```{r examples-plot_correlation}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

plot_correlation(datalist = datalist,
              dico = dico, 
              var = "profile.occupation")
```

## Plotting Header variable

```{r examples-plot_header}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )

plot_header( dico = dico, 
              var = "profile")
```

# Report generation

## Crunching Variables based on a plan

```{r examples-kobo_cruncher}
dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )

kobo_cruncher(datalist = datalist,
              dico = dico)


```

 


## Report Template 1 for Automatic Data Exploration

The first RMD template gives an output in HTML for easy navigation - the left menu provides smooth transition.

It includes a function to automatically run throughout all the survey content. During this stage, data cleaning and new variable creation can be performed through iterations

This report also includes each plot syntax so that they can be easily pasted for the second report



## Report Template 2 for Joint Data Interpretation Session

The second template is used following the systematic data exploration. 
It will generate a powerpoint presentation

See a more detailed presentation of that step here: https://www.youtube.com/watch?v=0jE-Y7g88K4&feature=youtu.be&t=2305 


## Report Template 3 for Dissemination and Data Story Telling Template

The last template can be used to take note of the data interpretation session.

It will generate a PDF or an paginated HTML page


