# WARNING - Generated by {fusen} from /dev/flat_dev.Rmd: do not edit by hand

#' @title Plotting Correlation
#' 
#' @description blbla
#' 
#' @param datalist An object of the "datalist" class as defined in kobocruncher 
#' @param dico An object of the "kobodico" class format as defined in kobocruncher
#' @param var name of the variable to display
#' @param by_var variable to use for cross tabulation
#' @param showcode display the code
#' @export

#' @examples
#' dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
#' datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )
#' 
#' plot_correlation(datalist = datalist,
#'               dico = dico, 
#'               var = "profile.occupation")
plot_correlation <- function(datalist = datalist, 
                      dico = dico,
                      var, 
                      by_var, 
                      showcode = FALSE) {
  
   # ### Testing number of levels for the 2 variables as 'x' and 'y' must have at least 2 levels
   # if ( by_var != var &
   #      (nlevels(as.factor(as.character(formula$target))) > 1 ) &
   #      (nlevels(as.factor(as.character(formula$tested))) > 1 ) &
   #                     
   #      ## If too many levels, the corrogram is not legible...
   #      (nlevels(as.factor(as.character(formula$target))) < 8 ) &
   #      (nlevels(as.factor(as.character(formula$tested))) < 8 ) &
   #      ## May have class with zero value...
   #      n.class == n.class.notnull
   #                     
   #                )
   #                { p.value  <- round(stats::chisq.test(formula$target,formula$tested)$p.value,4)
   #                } else {            }
   #              
   #              ## Subsetting results on test where p-value is below 0.05
   #              chiquare.true <- chiquare.resultall[ chiquare.resultall$p.value <= 0.05, ]
   #              
   #              ### Case there not any positive test
   #              if (p.value <= 0.05 ) {
   #                cat("No significant association found for this question...\n")
   #              } else {
   #                ## now generating correlation plot for each of the dependent.
   # 
   #                 p <-   corrplot::corrplot(stats::chisq.test(
   #                   MainDataFrame$monit.FamiliyLeft,
   #                   MainDataFrame$monit.RouteIncident)$residuals,
   #                is.cor = FALSE, # use for general matrix to convert to Sq form
   #                cl.pos = "n", ## Do not display the color legend
   #                cl.cex = 0.7, # Size of all label
   #                tl.cex = 0.7, # Size of axis label
   #                tl.srt = 45, # string rotation in degrees
   #                tl.col = "black", # color of text label.
   #                addCoef.col = "grey", # add coeff in the chart
   #                number.cex = 3/ncol(stats::chisq.test(MainDataFrame$monit.FamiliyLeft,MainDataFrame$monit.RouteIncident)), # size of coeff
   #                mar = c(0.5,0.5,4, 0.5), ## margin of plots
   #                title = paste0("Correlation between ", , " & ", )) 
   #                 
   #                 print(p)
   # 
   #              }
}


#' @title Plotting numeric variable
#' @param datalist An object of the "datalist" class as defined in kobocruncher 
#' @param dico An object of the "kobodico" class format as defined in kobocruncher
#' @param var name of the variable to display
#' @param by_var variable to use for cross tabulation
#' @param showcode display the code
#' @export

#' @examples
#' dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
#' datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )
#' 
#' plot_integer_cross(datalist = datalist,
#'               dico = dico, 
#'               var = "members.age",
#'               by_var = "members.sex",
#'               showcode = TRUE)
plot_integer_cross <- function(datalist = datalist, 
                         dico = dico,
                         var, 
                         by_var ,
                         showcode = FALSE) {
  
  require("ggplot2")
  datasource <- as.character(  dico[3][[1]]$form_title ) 
  data <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = var  )
  ## Cast just in case...
  data[[var]] <- as.integer(data[[var]])
  ## get response rate: rr
  rr <- mean(!is.na(data[[var]]))
  
   data2 <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = by_var   )
  
  ## get response rate: rr
  rr <- mean(!is.na(data[[var]]))
  rr2 <- mean(!is.na(data2[[by_var]]))
  ## Writing report
  # cat("\n")
 # cat(paste("####", label_varname(var)))
  #cat(paste("#### Variable: ", var))
  
  if ( is.nan(rr) | is.nan(rr2) ) {
    cat("<strong style=\"color:#0072BC;\">This variable could not be identified in the dataset</strong>\n\n")
  } else if (  ! (identical(data,data2))  ) {
    # nothing to do - the variable are not in the same frame
    } else {
  
  ## Writing report
  if (rr != 0 & ! (is.nan(rr)) ) { 
      ## Writing code instruction in report
      if( showcode == TRUE) {
        cat(paste0(label_varname(dico = dico,
                                                   x = var), "\n",
                                      fontawesome::fa("far fa-copy", fill ="grey"),"  `plot_integer(datalist = datalist, dico = dico, \"", var, "\")` \n\n "))}    else {}
    
    p <- ggplot(data) + 
      geom_boxplot(aes(x = .data[[var]], y =  .data[[by_var]]), 
                     fill = "#0072BC", 
                     color = "white" 
      ) +
      # scale_y_continuous(labels = scales::label_percent()) +
      labs(x = NULL, y = NULL,
             title = stringr::str_wrap(label_varname(dico = dico, 
                                                         x = var), 80),
             subtitle = stringr::str_wrap( paste0("Crossed by ", label_varname(dico = dico,
                                                         x = by_var)), 80),
           caption = glue::glue("Numeric response, Response rate = {scales::label_percent(accuracy = .01)(rr)} on a total of {nrow(data)} records \n Source: {datasource}")) +
      
      scale_size_area(max_size = 10) +        
      scale_y_discrete(labels = function(x) {label_choiceset(dico = dico,
                                                          x = var)(x) |>
            stringr::str_wrap(40)}) +
      theme_minimal( base_size = 13) +
      geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
      theme( panel.grid.major.y  = element_line(color = "#cbcbcb"), 
           panel.grid.major.x  = element_blank(), 
           panel.grid.minor = element_blank()    ) +
           theme(plot.title.position = "plot")
    
    print(p)
    
    } else { cat("<strong style=\"color:#0072BC;\">No recorded answers for this specific question!</strong>\n\n")}
  # cat("\n\n")
  }
}


#' @title Plotting Select multiple variable with cross tabulation on a second categorical variable
#' @description
#' Note that if the column order is set in the xlsform choice part, the variable will be de factor considered as ordinal and the default ordering will not be done based on frequency
#' @param datalist An object of the "datalist" class as defined in kobocruncher 
#' @param dico An object of the "kobodico" class format as defined in kobocruncher
#' @param var name of the variable to display
#' @param by_var variable to use for cross tabulation
#' @param showcode display the code
#' @export

#' @examples
#' dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
#' datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )
#' 
#' plot_select_multiple_cross(datalist = datalist,
#'               dico = dico, 
#'               var = "profile.reason",
#'               by_var = "location",
#'               showcode = TRUE)
plot_select_multiple_cross <- function(datalist = datalist,
                                       dico = dico,
                                       var, 
                                       by_var , 
                                       showcode = FALSE) {
  
  
  require("ggplot2")
  datasource <- as.character(  dico[3][[1]]$form_title ) 
  data <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = var  )
  ## get response rate: rr
  rr <- mean(!is.na(data[[var]]))
  nr <- sum(!is.na(data[[var]]))
  
   data2 <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = by_var   )
  
  ## get response rate: rr
  rr <- mean(!is.na(data[[var]]))
  rr2 <- mean(!is.na(data2[[by_var]]))
  ## Writing report
  # cat("\n")
 # cat(paste("####", label_varname(var)))
  #cat(paste("#### Variable: ", var))
  
  if ( is.nan(rr) | is.nan(rr2) ) {
    cat("<strong style=\"color:#0072BC;\">This variable could not be identified in the dataset</strong>\n\n")
  } else if (  ! (identical(data,data2))  ) {
    # nothing to do - the variable are not in the same frame
    } else {
  
  ## Writing report
  if (rr != 0 & ! (is.nan(rr))  ) { 
    
    if(by_var != "") {
      if( by_var != var ) {
        
          ## Writing code instruction in report
          if( showcode == TRUE) {
             cat(paste0(label_varname(dico = dico,
                                                   x = var), "\n",
                                      fontawesome::fa("far fa-copy", fill ="grey"), "  `plot_select_multiple_cross(datalist = datalist, dico = dico, \"", var, "\",\"", by_var, "\")` \n\n "))}   else {}

        
      cntscross <- data |>
        ## keep only the variable we need 
        tidyr::drop_na( tidyselect::all_of(c(var,by_var))) |>
        ## Separate the var with select_multiple 
        tidyr::separate_rows(.data[[var]], sep = " ") |>
        # Lump together factor levels into "other"
        dplyr::distinct(`X_id`, 
                 !!var := forcats::fct_lump_n(factor(.data[[var]]), n = 5),
                 !!by_var := forcats::fct_lump_n(factor(.data[[by_var]]), n = 5) ) |>
        # Lump together factor levels into "other"
        dplyr::count(x := .data[[var]],
                     y := .data[[by_var]] ) |>
        dplyr::mutate(p = n/sum(n)) |>
        dplyr::group_by(y) |>
        dplyr::mutate(cumsum = max(cumsum(as.numeric(n))),
                      pcum = n / cumsum)  
      ##plot
       p <- ggplot(cntscross, 
                  aes(x= pcum, 
                      y = x)) +
        geom_col(fill = "#0072BC") +
        #geom_label(aes(label = scales::label_percent(accuracy = .01)(pcum)), size = 2) +
        ## Position label differently in the bar in white - outside bar in black
        geom_label( data =   function(x) subset(x, pcum < max(pcum) / 1.5),
                    aes(label = scales::label_percent(accuracy = .01)(pcum)),
                    hjust = -0.1 ,
                    vjust = 0.5, 
                    colour = "black", 
                    fill = NA, 
                    label.size = NA, 
                     
                    size = 3   ) +  
        geom_label( data =   function(x) subset(x, pcum >= max(pcum) / 1.5),
                    aes(label = scales::label_percent(accuracy = .01)(pcum)),
                    hjust = 1.1 ,
                    vjust = 0.5, 
                    colour = "white", 
                    fill = NA, 
                    label.size = NA, 
                     
                    size = 3   ) +   
        scale_x_continuous(labels = scales::label_percent()) +
        facet_wrap( ~ y ,  nrow = 3,
                    labeller = as_labeller(function(x) label_choiceset(dico = dico,
                                                         x= by_var)(x))
                    ) +
        scale_y_discrete(labels = function(x) {label_choiceset(dico = dico,
                                                          x = var)(x) |>
            stringr::str_wrap(40)}) +
        coord_cartesian(clip = "off") +
        labs(x = NULL, y = NULL,
             title = stringr::str_wrap(label_varname(dico = dico, 
                                                         x = var), 80),
             subtitle = stringr::str_wrap( paste0("Crossed by ", label_varname(dico = dico,
                                                         x = by_var)), 80),
             caption = glue::glue("Multiple choice question, Response rate = {scales::label_percent(accuracy = .01)(rr)} on a total of {nrow(data)} records \n Source: {datasource}")) +
        theme_minimal( base_size = 13) +  
        geom_vline(xintercept = 0, size = 1.1, colour = "#333333") +
        theme( panel.grid.major.x  = element_line(color = "#cbcbcb"), 
               panel.grid.major.y  = element_blank(), 
               panel.grid.minor = element_blank()    ) +
        theme(plot.title.position = "plot")
      
       print(p)
    }   
    } else { }
  } else { cat("<strong style=\"color:#0072BC;\">No recorded answers for this specific question!</strong>\n\n")}
  # cat("\n\n")
    
  }
}



#' @title Plotting Select one variable with cross tabulation on a second categorical variable
#' @description
#' Note that if the column order is set in the xlsform choice part, the variable will be de factor considered as ordinal and the default ordering will not be done based on frequency
#' @param datalist An object of the "datalist" class as defined in kobocruncher 
#' @param dico An object of the "kobodico" class format as defined in kobocruncher
#' @param var name of the variable to display
#' @param by_var variable to use for cross tabulation
#' @param showcode display the code
#' @export

#' @examples
#' dico <- kobo_dico( xlsformpath = system.file("sample_xlsform.xlsx", package = "kobocruncher") )
#' datalist <- kobo_data(datapath = system.file("data.xlsx", package = "kobocruncher") )
#' 
#' plot_select_one_cross(datalist = datalist,
#'               dico = dico, 
#'               var = "profile.country",
#'               by_var = "profile.occupation",
#'               showcode = TRUE
#'               )
#' ## test if variable are not in the same frame...
#' plot_select_one_cross(datalist = datalist,
#'               dico = dico, 
#'               var = "profile.country",
#'               by_var = "members.sex",
#'               showcode = TRUE
#'               )
#' 
plot_select_one_cross <- function(datalist = datalist,
                            dico = dico,
                            var, 
                            by_var , 
                            showcode = FALSE) {
  
  require("ggplot2")
  datasource <- as.character(  dico[3][[1]]$form_title ) 
  data <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = var  )
  
  data2 <- kobo_frame(datalist = datalist,
                   dico = dico,
                   var = by_var   )
  
  ## get response rate: rr
  rr <- mean(!is.na(data[[var]]))
  rr2 <- mean(!is.na(data2[[by_var]]))
  ## Writing report
  # cat("\n")
 # cat(paste("####", label_varname(var)))
  #cat(paste("#### Variable: ", var))
  
  if ( is.nan(rr) | is.nan(rr2) ) {
    cat("<strong style=\"color:#0072BC;\">This variable could not be identified in the dataset</strong>\n\n")
  } else if (  ! (identical(data,data2))  ) {
    # nothing to do - the variable are not in the same frame
    } else {
  
  ## Put a condition in case there's no record
  if (rr != 0 & ! (is.nan(rr)) ) { 
    if(by_var != "") {
      if( by_var != var ) {
        
          ## Writing code instruction in report
          if( showcode == TRUE) { 
            cat(paste0( label_varname(dico = dico,
                                                   x = var), "\n",
                                      fontawesome::fa("far fa-copy", fill ="grey"),"  `plot_select_one_cross(datalist = datalist, dico = dico, \"", var, "\",\"", by_var, "\")` \n\n "))}     else {}

      cnts <- data |>
        ## keep only the variable we need
        tidyr::drop_na(tidyselect::all_of(c(var,by_var))) |>
        # Lump together factor levels into "other"
        dplyr::count(x := forcats::fct_lump_n(factor(.data[[var]]), n = 5),
                     y := forcats::fct_lump_n(factor(.data[[by_var]]), n = 5) ) |>
        dplyr::mutate(p = n/sum(n)) |>
        dplyr::group_by(y) |>
        dplyr::mutate(cumsum = max(cumsum(as.numeric(n))),
                      pcum = n / cumsum)  
       
       ## plot
       p <- ggplot(cnts, 
                  aes(x= pcum, 
                      y = x)) +
        geom_col(fill = "#0072BC") +
        #geom_label(aes(label = scales::label_percent(accuracy = .01)(pcum)), size = 2) +
        ## Position label differently in the bar in white - outside bar in black
        geom_label( data =   function(x) subset(x, pcum < max(pcum) / 1.5),
                    aes(label = scales::label_percent(accuracy = .01)(pcum)),
                    hjust = -0.1 ,
                    vjust = 0.5, 
                    colour = "black", 
                    fill = NA, 
                    label.size = NA, 
                     
                    size = 3   ) +  
        geom_label( data =   function(x) subset(x, pcum >= max(pcum) / 1.5),
                    aes(label = scales::label_percent(accuracy = .01)(pcum)),
                    hjust = 1.1 ,
                    vjust = 0.5, 
                    colour = "white", 
                    fill = NA, 
                    label.size = NA, 
                     
                    size = 3   ) +   
        scale_x_continuous(labels = scales::label_percent()) +
         
        facet_wrap( ~ y ,  nrow = 3  ,
                      labeller = as_labeller(function(x) label_choiceset(dico = dico,
                                                                      x = by_var)(x))
          ) +
          scale_y_discrete(labels = function(x) {label_choiceset(dico = dico,
                                                            x = var)(x) |>
              stringr::str_wrap(40)}) +
        coord_cartesian(clip = "off") +
        labs(x = NULL, y = NULL,
               title = stringr::str_wrap(label_varname(dico = dico,
                                                       x = var), 80),
               subtitle = stringr::str_wrap( paste0("Crossed by ", label_varname(dico = dico,
                                                                                 x = by_var)), 80),
               caption = glue::glue("Single choice question, Response rate = {scales::label_percent(accuracy = .01)(rr)} on a total of {nrow(data)} records \n Source: {datasource}")) +
        theme_minimal( base_size = 13) +  
        geom_vline(xintercept = 0, size = 1.1, colour = "#333333") +
        theme( panel.grid.major.x  = element_line(color = "#cbcbcb"), 
                 panel.grid.major.y  = element_blank(), 
                 panel.grid.minor = element_blank()    ) +
        theme(plot.title.position = "plot")

        print(p)
    
      }
    } else { }
  } else { cat("<strong style=\"color:#0072BC;\">No recorded answers for this specific question!</strong> \n\n")}
  # cat("\n\n")
  }
}


